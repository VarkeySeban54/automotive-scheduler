<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Management</title>
    <style>
        :root {
            --bg: #0a0b0f;
            --surface: #ffffff;
            --surface-muted: #f8fafc;
            --text: #1f2937;
            --text-soft: #64748b;
            --brand: #f5cc1f;
            --brand-dark: #e0b705;
            --border: #dbe4f0;
            --danger: #dc2626;
            --danger-soft: #fee2e2;
            --success: #16a34a;
            --success-soft: #dcfce7;
            --shadow-soft: 0 10px 24px rgba(15, 23, 42, 0.06);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background:
                radial-gradient(circle at 15% 25%, rgba(245, 204, 31, 0.08), transparent 30%),
                radial-gradient(circle at 90% 75%, rgba(245, 204, 31, 0.06), transparent 36%),
                #08090b;
            color: var(--text);
            min-height: 100vh;
        }

        .site-header { position: sticky; top: 0; z-index: 20; box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35); }
        .brand-strip {
            background: #ffffff;
            color: #0f172a;
            padding: 18px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f1f5f9;
        }

        .brand-strip h1 { margin: 0; font-size: 2rem; letter-spacing: 0.3px; }
        .brand-strip .accent { color: var(--brand-dark); }

        .navbar {
            background: var(--brand);
            color: #0f172a;
            padding: 14px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .ops-label { font-weight: 700; letter-spacing: 0.2px; }

        .user-info { display: flex; align-items: center; gap: 12px; font-weight: 600; }

        .nav-link,
        .logout-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #111827;
            color: var(--brand);
            border: 1px solid #111827;
            border-radius: 999px;
            padding: 10px 16px;
            text-decoration: none;
            font-weight: 700;
            transition: 0.2s ease;
        }

        .nav-link:hover,
        .logout-btn:hover { background: #000000; transform: translateY(-1px); }

        .container { max-width: 1200px; margin: 0 auto; padding: 22px; }
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 22px;
            margin-bottom: 18px;
            box-shadow: var(--shadow-soft);
        }

        h2 { margin: 0 0 14px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
        label { display: block; margin-bottom: 6px; color: var(--text-soft); font-weight: 600; font-size: 0.88rem; }

        input, select {
            width: 100%;
            padding: 11px 12px;
            border: 1px solid var(--border);
            background: var(--surface-muted);
            border-radius: 10px;
            font-size: 0.96rem;
        }

        input:focus, select:focus { outline: none; border-color: var(--brand); background: #fff; }

        button {
            padding: 10px 14px;
            border: 0;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--brand), var(--brand-dark));
            color: #111827;
            font-weight: 700;
            cursor: pointer;
        }

        table { width: 100%; border-collapse: collapse; }
        th, td { border-bottom: 1px solid #e2e8f0; padding: 10px 8px; text-align: left; font-size: .92rem; }
        .actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .muted { color: #64748b; margin-top: 0; }
        .message { margin-top: 10px; font-weight: 700; padding: 10px 12px; border-radius: 10px; display: none; }
        .error { color: #7f1d1d; background: var(--danger-soft); display: block; }
        .ok { color: #166534; background: var(--success-soft); display: block; }
        .hidden { display: none; }
        .error-banner {
            margin-top: 12px;
            background: var(--danger-soft);
            color: #7f1d1d;
            padding: 10px 12px;
            border-radius: 10px;
            display: none;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="brand-strip">
            <h1>Marvel Auto <span class="accent">London</span></h1>
            <div>Trusted Workshop Dashboard</div>
        </div>
        <div class="navbar">
            <div class="ops-label">Internal Operations Dashboard</div>
            <div class="user-info">
                <a class="nav-link" href="/admin/dashboard">Back to Dashboard</a>
                <div>Admin: {{ user_name }}</div>
                <a class="logout-btn" href="/logout">Logout</a>
            </div>
        </div>
    </header>

    <main class="container">
        <section class="card">
            <h2>Create User</h2>
            <form id="createForm">
                <div class="grid">
                    <div><label for="name">Name *</label><input id="name" required /></div>
                    <div><label for="email">Email *</label><input id="email" type="email" required /></div>
                    <div><label for="password">Password *</label><input id="password" type="password" minlength="8" required /></div>
                    <div>
                        <label for="role">Role *</label>
                        <select id="role" required>
                            <option value="admin">Admin</option>
                            <option value="frontdesk">Front Desk</option>
                            <option value="mechanic">Mechanic</option>
                        </select>
                    </div>
                    <div>
                        <label for="active">Status</label>
                        <select id="active">
                            <option value="1">Active</option>
                            <option value="0">Inactive</option>
                        </select>
                    </div>
                    <div id="mechanicCreateWrap" class="hidden">
                        <label for="mechanicId">Mechanic Mapping *</label>
                        <select id="mechanicId"><option value="">Select mechanic...</option></select>
                    </div>
                </div>
                <div style="margin-top: 12px;"><button type="submit">Create User</button></div>
                <p class="message" id="createMessage"></p>
            </form>
        </section>

        <section class="card">
            <h2>Existing Users</h2>
            <p class="muted">Edit role/status/mechanic mapping inline and save.</p>
            <div class="error-banner" id="tableErrorBanner"></div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>Mechanic ID</th><th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersBody"></tbody>
            </table>
            <p class="message" id="tableMessage"></p>
        </section>
    </main>

    <script>
        const usersBody = document.getElementById('usersBody');
        const createMessage = document.getElementById('createMessage');
        const tableMessage = document.getElementById('tableMessage');
        const tableErrorBanner = document.getElementById('tableErrorBanner');
        const mechanicSelect = document.getElementById('mechanicId');
        const createRoleSelect = document.getElementById('role');
        const mechanicCreateWrap = document.getElementById('mechanicCreateWrap');

        function message(el, text, isError=false) {
            el.textContent = text;
            el.className = `message ${isError ? 'error' : 'ok'}`;
        }

        function setTableError(messageText='') {
            if (!messageText) {
                tableErrorBanner.style.display = 'none';
                tableErrorBanner.textContent = '';
                return;
            }
            tableErrorBanner.textContent = messageText;
            tableErrorBanner.style.display = 'block';
        }

        function mechanicOptions(mechanics, selected='') {
            const options = ['<option value="">Select mechanic...</option>'];
            for (const m of mechanics) {
                options.push(`<option value="${m.mechanic_id}" ${selected===m.mechanic_id?'selected':''}>${m.name} (${m.mechanic_id})</option>`);
            }
            return options.join('');
        }

        function toggleCreateMechanicRequirement() {
            const isMechanic = createRoleSelect.value === 'mechanic';
            mechanicCreateWrap.classList.toggle('hidden', !isMechanic);
            if (!isMechanic) {
                mechanicSelect.value = '';
            }
        }

        function updateRowMechanicState(row) {
            const roleSelect = row.querySelector('[data-field="role"]');
            const mechanicField = row.querySelector('[data-field="mechanic_id"]');
            const isMechanic = roleSelect.value === 'mechanic';
            mechanicField.disabled = !isMechanic;
            if (!isMechanic) {
                mechanicField.value = '';
            }
        }

        async function loadUsers() {
            setTableError();
            const res = await fetch('/api/admin/users');
            const data = await res.json();
            if (!res.ok || !data.success) {
                console.error('Failed to load users', data);
                setTableError(data.error || 'Failed to load users. Please try again.');
                return;
            }

            mechanicSelect.innerHTML = mechanicOptions(data.mechanics);
            usersBody.innerHTML = data.users.map(user => `
                <tr data-user-id="${user.id}">
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>
                        <select data-field="role" onchange="updateRowMechanicState(this.closest('tr'))">
                            <option value="admin" ${user.role==='admin'?'selected':''}>Admin</option>
                            <option value="frontdesk" ${user.role==='frontdesk'?'selected':''}>Front Desk</option>
                            <option value="mechanic" ${user.role==='mechanic'?'selected':''}>Mechanic</option>
                        </select>
                    </td>
                    <td>
                        <select data-field="active">
                            <option value="1" ${user.active ? 'selected':''}>Active</option>
                            <option value="0" ${!user.active ? 'selected':''}>Inactive</option>
                        </select>
                    </td>
                    <td>
                        <select data-field="mechanic_id">
                            ${mechanicOptions(data.mechanics, user.mechanic_id || '')}
                        </select>
                    </td>
                    <td class="actions">
                        <button onclick="saveUser(${user.id})">Save</button>
                    </td>
                </tr>
            `).join('');

            document.querySelectorAll('#usersBody tr').forEach(updateRowMechanicState);
        }

        async function saveUser(userId) {
            const row = document.querySelector(`tr[data-user-id='${userId}']`);
            const role = row.querySelector('[data-field="role"]').value;
            const mechanicId = row.querySelector('[data-field="mechanic_id"]').value;

            if (role === 'mechanic' && !mechanicId) {
                message(tableMessage, 'Mechanic mapping is required for mechanic role', true);
                return;
            }

            const payload = {
                role,
                active: row.querySelector('[data-field="active"]').value,
                mechanic_id: mechanicId,
            };

            const res = await fetch(`/api/admin/users/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const data = await res.json();
            if (!res.ok || !data.success) {
                message(tableMessage, data.error || 'Failed to update user', true);
                return;
            }
            message(tableMessage, 'User updated');
            await loadUsers();
        }

        document.getElementById('createForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            const role = document.getElementById('role').value;
            const mechanicId = mechanicSelect.value;
            if (role === 'mechanic' && !mechanicId) {
                message(createMessage, 'Mechanic mapping is required for mechanic role', true);
                return;
            }

            const payload = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                role,
                active: document.getElementById('active').value,
                mechanic_id: mechanicId,
            };

            const res = await fetch('/api/admin/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const data = await res.json();
            if (!res.ok || !data.success) {
                message(createMessage, data.error || 'Failed to create user', true);
                return;
            }
            message(createMessage, 'User created successfully');
            event.target.reset();
            toggleCreateMechanicRequirement();
            await loadUsers();
        });

        createRoleSelect.addEventListener('change', toggleCreateMechanicRequirement);

        toggleCreateMechanicRequirement();
        loadUsers().catch((error) => {
            console.error('Error loading user data', error);
            setTableError('Error loading user data. Please refresh and try again.');
        });
    </script>
</body>
</html>
